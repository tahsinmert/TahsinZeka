<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TahsinZeka - AI Asistan</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="tahsinzeka-logo.png">
    <link rel="shortcut icon" type="image/png" href="tahsinzeka-logo.png">
    
    <!-- Apple Touch Icon (iPhone/iPad Ana Ekran) -->
    <link rel="apple-touch-icon" href="tahsinzeka-logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="tahsinzeka-logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="tahsinzeka-logo.png">
    <link rel="apple-touch-icon" sizes="167x167" href="tahsinzeka-logo.png">
    
    <!-- Android/Chrome -->
    <link rel="icon" sizes="192x192" href="tahsinzeka-logo.png">
    <link rel="icon" sizes="512x512" href="tahsinzeka-logo.png">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#10a37f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TahsinZeka">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #f7f7f8;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Tablet optimizasyonlarƒ± */
        @media screen and (min-width: 768px) and (max-width: 1024px) {
            body {
                height: 100vh;
                overflow: hidden;
            }
            
            .chat-container {
                height: 100vh;
                max-height: 100vh;
            }
            
            .chat-header {
                padding: 24px 32px;
                min-height: 80px;
            }
            
            .chat-header h1 {
                font-size: 24px;
            }
            
            .chat-header-logo {
                width: 44px;
                height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            #chat-history {
                padding: 24px 32px;
                max-height: calc(100vh - 160px);
                overflow-y: auto;
            }
            
            .input-area {
                padding: 24px 32px;
                min-height: 100px;
            }
            
            .input-wrapper {
                gap: 16px;
                max-width: 100%;
            }
            
            #user-input {
                font-size: 16px;
                padding: 16px 20px;
                min-height: 56px;
                max-height: 200px;
            }
            
            #image-button {
                padding: 16px 20px;
                font-size: 16px;
                min-width: 60px;
            }
            
            #send-button {
                padding: 16px 32px;
                font-size: 16px;
                min-width: 100px;
            }
            
            .message-wrapper {
                margin-bottom: 28px;
                padding: 20px;
            }
            
            .message-sender {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .message-content {
                font-size: 16px;
                line-height: 1.8;
            }
            
            .message-content h1 {
                font-size: 28px;
                margin: 28px 0 20px 0;
            }
            
            .message-content h2 {
                font-size: 24px;
                margin: 24px 0 16px 0;
            }
            
            .message-content h3 {
                font-size: 20px;
                margin: 20px 0 12px 0;
            }
            
            .connection-status {
                bottom: 160px;
                right: 24px;
                font-size: 13px;
                padding: 10px 18px;
            }
            
            .stop-button {
                bottom: 220px;
                right: 24px;
                width: 40px;
                height: 40px;
            }
            
            .stop-button svg {
                width: 18px;
                height: 18px;
            }
            
            .scroll-to-bottom {
                bottom: 160px;
                width: 44px;
                height: 44px;
            }
            
            .scroll-to-bottom svg {
                width: 22px;
                height: 22px;
            }
        }
        
        /* iPad Pro ve b√ºy√ºk tabletler */
        @media screen and (min-width: 1024px) and (max-width: 1366px) {
            .chat-container {
                max-width: 1200px;
                margin: 0 auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            
            .chat-header {
                padding: 28px 40px;
            }
            
            #chat-history {
                padding: 28px 40px;
            }
            
            .input-area {
                padding: 28px 40px;
            }
        }
        
        .chat-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
            background: #ffffff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-header-logo {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-header-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .chat-header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #202123;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        #chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
        }
        
        /* Right sidebar for animations */
        .right-sidebar {
            width: 280px;
            background: linear-gradient(135deg, #f7f7f8 0%, #ffffff 100%);
            border-left: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-content {
            text-align: center;
            z-index: 2;
        }
        
        .sidebar-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }
        
        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #202123;
            margin-bottom: 8px;
        }
        
        .sidebar-description {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.6;
        }
        
        /* Background animated shapes */
        .bg-shape {
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            z-index: 1;
        }
        
        .shape-1 {
            width: 150px;
            height: 150px;
            background: #10a37f;
            top: -50px;
            right: -50px;
            animation: rotate 20s linear infinite;
        }
        
        .shape-2 {
            width: 100px;
            height: 100px;
            background: #0ea5e9;
            bottom: -30px;
            left: -30px;
            animation: rotate 15s linear infinite reverse;
        }
        
        .shape-3 {
            width: 80px;
            height: 80px;
            background: #8b5cf6;
            top: 50%;
            left: 10%;
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        /* Thinking animation */
        .thinking-animation {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .thinking-dot {
            width: 12px;
            height: 12px;
            background: #10a37f;
            border-radius: 50%;
            animation: thinking 1.4s ease-in-out infinite;
        }
        
        .thinking-dot:nth-child(1) { animation-delay: 0s; }
        .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes thinking {
            0%, 60%, 100% { 
                transform: scale(1);
                opacity: 0.7;
            }
            30% { 
                transform: scale(1.3);
                opacity: 1;
            }
        }
        
        /* Particle effect */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #10a37f;
            border-radius: 50%;
            opacity: 0;
            animation: particle 3s ease-out infinite;
        }
        
        @keyframes particle {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0);
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1);
            }
        }
        
        /* Hide sidebar on mobile and tablet */
        @media screen and (max-width: 1024px) {
            .right-sidebar {
                display: none;
            }
        }
        
        .message-wrapper {
            margin-bottom: 24px;
            padding: 16px;
            border-radius: 8px;
        }
        
        .user-message {
            background: #f7f7f8;
            border-left: 3px solid #10a37f;
        }
        
        .ai-message {
            background: #ffffff;
            border-left: 3px solid #8e8ea0;
        }
        
        .message-sender {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            color: #202123;
        }
        
        .message-content {
            line-height: 1.7;
            color: #353740;
            font-size: 15px;
        }
        
        .message-content h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 24px 0 16px 0;
            color: #202123;
            border-bottom: 2px solid #e5e5e5;
            padding-bottom: 12px;
        }
        
        .message-content h2 {
            font-size: 20px;
            font-weight: 600;
            margin: 20px 0 12px 0;
            color: #202123;
            border-bottom: 1px solid #ececf1;
            padding-bottom: 8px;
        }
        
        .message-content h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 18px 0 10px 0;
            color: #202123;
        }
        
        .message-content h4 {
            font-size: 16px;
            font-weight: 600;
            margin: 16px 0 8px 0;
            color: #353740;
        }
        
        .message-content h5, .message-content h6 {
            font-size: 15px;
            font-weight: 600;
            margin: 14px 0 6px 0;
            color: #353740;
        }
        
        .message-content p {
            margin: 12px 0;
            line-height: 1.7;
        }
        
        .message-content ul, .message-content ol {
            margin: 12px 0;
            padding-left: 28px;
        }
        
        .message-content li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .message-content ul li {
            list-style-type: disc;
        }
        
        .message-content ol li {
            list-style-type: decimal;
        }
        
        .message-content code {
            background-color: #f4f4f4;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Courier New', monospace;
            font-size: 0.9em;
            color: #d73a49;
            border: 1px solid #e1e4e8;
        }
        
        .message-content pre {
            background-color: #282c34;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
            border: none;
            color: #abb2bf;
            display: block;
        }
        
        .message-content blockquote {
            border-left: 4px solid #10a37f;
            padding-left: 16px;
            margin: 16px 0;
            color: #565869;
            font-style: italic;
            background: #f7f7f8;
            padding: 12px 16px;
            border-radius: 0 4px 4px 0;
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
            border: 1px solid #d9d9e3;
        }
        
        .message-content th, .message-content td {
            border: 1px solid #d9d9e3;
            padding: 10px 14px;
            text-align: left;
        }
        
        .message-content th {
            background-color: #f7f7f8;
            font-weight: 600;
            color: #202123;
        }
        
        .message-content strong {
            font-weight: 700;
            color: #202123;
        }
        
        .message-content a {
            color: #10a37f;
            text-decoration: none;
        }
        
        .message-content a:hover {
            text-decoration: underline;
        }
        
        .input-area {
            padding: 20px;
            border-top: 1px solid #e5e5e5;
            background: #ffffff;
        }
        
        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            width: 100%;
            flex-wrap: nowrap;
        }
        
        .input-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        #image-preview-container {
            display: none;
            position: relative;
            max-width: 200px;
        }
        
        #image-preview-container.show {
            display: block;
        }
        
        #image-preview {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #d9d9e3;
        }
        
        #remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        #remove-image:hover {
            background: #dc2626;
        }
        
        .input-row {
            display: flex;
            gap: 8px;
            width: 100%;
            flex-wrap: nowrap;
        }
        
        #user-input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid #d9d9e3;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
            resize: none;
            min-height: 48px;
            max-height: 200px;
            width: 100%;
            box-sizing: border-box;
        }
        
        #user-input:focus {
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }
        
        #image-button {
            padding: 14px 16px;
            background: #f7f7f8;
            color: #353740;
            border: 1px solid #d9d9e3;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            min-width: 50px;
        }
        
        #image-button:hover {
            background: #ececf1;
            border-color: #c5c5d2;
        }
        
        #image-input {
            display: none;
        }
        
        #send-button {
            padding: 14px 28px;
            background: #10a37f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
            min-width: 80px;
        }
        
        #send-button:hover:not(:disabled) {
            background: #0d8c6a;
        }
        
        #send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .message-image {
            max-width: 400px;
            max-height: 400px;
            border-radius: 8px;
            margin-top: 8px;
            border: 1px solid #e5e5e5;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .message-image:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .analyzing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0f9ff;
            border-left: 3px solid #0ea5e9;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 14px;
            color: #0369a1;
        }
        
        .analyzing-indicator::before {
            content: "üîç";
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        
        .image-info {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
            font-style: italic;
        }
        
        #chat-history::-webkit-scrollbar {
            width: 8px;
        }
        
        #chat-history::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        #chat-history::-webkit-scrollbar-thumb {
            background: #c5c5d2;
            border-radius: 4px;
        }
        
        #chat-history::-webkit-scrollbar-thumb:hover {
            background: #a8a8b3;
        }
        
        /* Typing indicator - Geli≈ümi≈ü loading animasyonu */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 12px 16px;
            background: #f0f9ff;
            border-radius: 18px;
            margin: 8px 0;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #10a37f;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        /* Connection status indicator */
        .connection-status {
            position: fixed;
            bottom: 140px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 6px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        .connection-status.online {
            background: #d1fae5;
            color: #065f46;
            display: flex;
        }
        
        .connection-status.offline {
            background: #fee2e2;
            color: #991b1b;
            display: flex;
        }
        
        .connection-status.slow {
            background: #fef3c7;
            color: #92400e;
            display: flex;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Retry button */
        .retry-button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
            transition: background 0.2s;
        }
        
        .retry-button:hover {
            background: #dc2626;
        }
        
        /* Smooth streaming effect */
        .streaming-text {
            animation: fadeIn 0.2s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Network quality indicator */
        .network-quality {
            font-size: 11px;
            color: #6b7280;
            padding: 4px 8px;
            background: #f3f4f6;
            border-radius: 4px;
            display: inline-block;
            margin-left: 8px;
        }
        
        /* Message actions */
        .message-actions {
            display: flex;
            gap: 6px;
            margin-top: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .message-wrapper:hover .message-actions {
            opacity: 1;
        }
        
        .action-button {
            padding: 6px 12px;
            background: #f7f7f8;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: #6b7280;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .action-button:hover {
            background: #ececf1;
            color: #202123;
            border-color: #d9d9e3;
        }
        
        .action-button svg {
            width: 14px;
            height: 14px;
        }
        
        .action-button.success {
            background: #d1fae5;
            color: #065f46;
            border-color: #a7f3d0;
        }
        
        /* Stop generation button */
        .stop-button {
            position: fixed;
            bottom: 200px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.95);
            color: #6b7280;
            border: 1px solid #e5e5e5;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: all 0.2s;
            backdrop-filter: blur(8px);
        }
        
        .stop-button:hover {
            background: rgba(255, 255, 255, 1);
            color: #ef4444;
            border-color: #fee2e2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }
        
        .stop-button.show {
            display: flex;
        }
        
        .stop-button svg {
            width: 16px;
            height: 16px;
        }
        
        /* Scroll to bottom button */
        .scroll-to-bottom {
            position: fixed;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            transition: all 0.2s;
            color: #6b7280;
        }
        
        .scroll-to-bottom:hover {
            background: #10a37f;
            color: white;
            border-color: #10a37f;
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 163, 127, 0.2);
        }
        
        .scroll-to-bottom.show {
            display: flex;
        }
        
        .scroll-to-bottom svg {
            width: 20px;
            height: 20px;
        }
        
        /* Suggested prompts */
        .suggested-prompts {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            overflow-x: auto;
            background: #f7f7f8;
            border-top: 1px solid #e5e5e5;
            scrollbar-width: none;
        }
        
        .suggested-prompts::-webkit-scrollbar {
            display: none;
        }
        
        .prompt-chip {
            padding: 8px 16px;
            background: white;
            border: 1px solid #d9d9e3;
            border-radius: 20px;
            font-size: 13px;
            color: #353740;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .prompt-chip:hover {
            background: #10a37f;
            color: white;
            border-color: #10a37f;
            transform: translateY(-1px);
        }
        
        /* Code block improvements */
        .message-content pre {
            position: relative;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #1e293b;
            border-radius: 8px 8px 0 0;
            margin-bottom: -8px;
        }
        
        .code-language {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .copy-code-button {
            padding: 4px 8px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 4px;
            color: #e2e8f0;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .copy-code-button:hover {
            background: #475569;
            color: white;
        }
        
        /* Welcome screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            min-height: 400px;
        }
        
        .welcome-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .welcome-title {
            font-size: 32px;
            font-weight: 700;
            color: #202123;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #10a37f 0%, #0d8c6a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .welcome-subtitle {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 32px;
        }
        
        .welcome-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            max-width: 800px;
            width: 100%;
        }
        
        .suggestion-card {
            padding: 16px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion-card:hover {
            border-color: #10a37f;
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.1);
            transform: translateY(-2px);
        }
        
        .suggestion-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .suggestion-title {
            font-size: 14px;
            font-weight: 600;
            color: #202123;
            margin-bottom: 4px;
        }
        
        .suggestion-text {
            font-size: 12px;
            color: #6b7280;
        }
        
        /* Export menu */
        .export-menu {
            position: fixed;
            top: 70px;
            right: 20px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 8px;
            display: none;
            z-index: 999;
            min-width: 200px;
        }
        
        .export-menu.show {
            display: block;
        }
        
        .export-option {
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #353740;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        
        .export-option:hover {
            background: #f7f7f8;
        }
        
        /* Header actions */
        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        
        .header-button {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            transition: all 0.2s;
        }
        
        .header-button:hover {
            background: #f7f7f8;
            color: #10a37f;
            border-color: #d9d9e3;
        }
        
        .header-button svg {
            width: 18px;
            height: 18px;
        }
        
        /* Mobile optimizations */
        @media screen and (max-width: 767px) {
            .connection-status {
                bottom: 120px;
                right: 12px;
                font-size: 11px;
                padding: 6px 12px;
            }
            
            .stop-button {
                bottom: 180px;
                right: 12px;
                width: 32px;
                height: 32px;
            }
            
            .stop-button svg {
                width: 14px;
                height: 14px;
            }
            
            .scroll-to-bottom {
                bottom: 120px;
                width: 36px;
                height: 36px;
            }
            
            .scroll-to-bottom svg {
                width: 18px;
                height: 18px;
            }
            
            .header-actions {
                gap: 6px;
            }
            
            .header-button {
                width: 32px;
                height: 32px;
            }
            
            .header-button svg {
                width: 16px;
                height: 16px;
            }
            
            .export-menu {
                top: 70px;
                right: 10px;
            }
            
            .chat-header {
                padding: 16px;
            }
            
            .chat-header h1 {
                font-size: 18px;
            }
            
            .chat-header-logo {
                width: 32px;
                height: 32px;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connection-status">
        <span class="status-dot"></span>
        <span id="connection-text">√áevrimi√ßi</span>
    </div>
    
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-header-logo">
                <img src="tahsinzeka-logo.png" alt="TahsinZeka Logo">
            </div>
            <h1>TahsinZeka</h1>
            <div class="header-actions">
                <button class="header-button" id="export-button" title="Dƒ±≈üa Aktar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                </button>
                <button class="header-button" id="clear-button" title="Sohbeti Temizle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Export Menu -->
        <div class="export-menu" id="export-menu">
            <div class="export-option" onclick="exportChat('markdown')">
                <span>üìÑ</span> Markdown olarak indir
            </div>
            <div class="export-option" onclick="exportChat('text')">
                <span>üìù</span> Text olarak indir
            </div>
            <div class="export-option" onclick="exportChat('json')">
                <span>üíæ</span> JSON olarak indir
            </div>
        </div>
        
        <!-- Stop Generation Button -->
        <button class="stop-button" id="stop-button" title="Yanƒ±tƒ± durdur">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="6" width="12" height="12" rx="2"></rect>
            </svg>
        </button>
        
        <!-- Scroll to Bottom Button -->
        <button class="scroll-to-bottom" id="scroll-to-bottom" title="En alta git">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="7 13 12 18 17 13"></polyline>
                <polyline points="7 6 12 11 17 6"></polyline>
            </svg>
        </button>
        
        <div class="chat-main">
            <div id="chat-history"></div>
            
            <!-- Right Sidebar -->
            <div class="right-sidebar" id="right-sidebar">
                <!-- Background shapes -->
                <div class="bg-shape shape-1"></div>
                <div class="bg-shape shape-2"></div>
                <div class="bg-shape shape-3"></div>
                
                <!-- Dynamic content -->
                <div class="sidebar-content" id="sidebar-content">
                    <div class="sidebar-icon">üß†</div>
                    <div class="sidebar-title">TahsinZeka</div>
                    <div class="sidebar-description">Size nasƒ±l yardƒ±mcƒ± olabilirim?</div>
                </div>
            </div>
        </div>
        
        <!-- Suggested Prompts -->
        <div class="suggested-prompts" id="suggested-prompts" style="display: none;">
            <div class="prompt-chip" onclick="useSuggestedPrompt('Bu kod nasƒ±l √ßalƒ±≈üƒ±r?')">üîç Kod a√ßƒ±kla</div>
            <div class="prompt-chip" onclick="useSuggestedPrompt('Bunu √∂zetler misin?')">üìã √ñzetle</div>
            <div class="prompt-chip" onclick="useSuggestedPrompt('Daha detaylƒ± anlat')">üìñ Detaylandƒ±r</div>
            <div class="prompt-chip" onclick="useSuggestedPrompt('Alternatif √ß√∂z√ºm √∂ner')">üí° Alternatif</div>
            <div class="prompt-chip" onclick="useSuggestedPrompt('√ñrnek ver')">üéØ √ñrnek</div>
        </div>
        <div class="input-area">
            <div class="input-wrapper">
                <div class="input-container">
                    <div id="image-preview-container">
                        <img id="image-preview" src="" alt="Preview">
                        <button id="remove-image">√ó</button>
                    </div>
                    <div class="input-row">
                        <textarea id="user-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." rows="1"></textarea>
                        <button id="image-button" title="G√∂rsel ekle">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </button>
                        <input type="file" id="image-input" accept="image/*">
                    </div>
                </div>
                <button id="send-button">G√∂nder</button>
            </div>
        </div>
    </div>

    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const imageButton = document.getElementById('image-button');
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageButton = document.getElementById('remove-image');
        const connectionStatus = document.getElementById('connection-status');
        const connectionText = document.getElementById('connection-text');
        const stopButton = document.getElementById('stop-button');
        const exportButton = document.getElementById('export-button');
        const exportMenu = document.getElementById('export-menu');
        const clearButton = document.getElementById('clear-button');
        const suggestedPrompts = document.getElementById('suggested-prompts');
        const scrollToBottomButton = document.getElementById('scroll-to-bottom');
        const sidebarContent = document.getElementById('sidebar-content');

        let selectedImage = null;
        let selectedImageUrl = null;
        let isStreaming = false;
        let streamStartTime = 0;
        let lastStreamTime = 0;
        let stopStreamingFlag = false;
        let currentStreamController = null;
        
        // Network monitoring
        let networkQuality = 'good'; // good, slow, offline
        let requestTimeout = null;
        
        // Local storage key
        const STORAGE_KEY = 'tahsinzeka_chat_history';
        
        // Auto-scroll management
        let isUserScrolling = false;
        let scrollTimeout = null;

        // Network quality monitoring
        function updateConnectionStatus(status) {
            connectionStatus.className = 'connection-status ' + status;
            
            if (status === 'online') {
                connectionText.textContent = '√áevrimi√ßi';
                networkQuality = 'good';
            } else if (status === 'slow') {
                connectionText.textContent = 'Yava≈ü baƒülantƒ±';
                networkQuality = 'slow';
            } else if (status === 'offline') {
                connectionText.textContent = 'Baƒülantƒ± yok';
                networkQuality = 'offline';
            }
            
            // Auto-hide after 3 seconds if online
            if (status === 'online') {
                setTimeout(() => {
                    connectionStatus.style.display = 'none';
                }, 3000);
            }
        }
        
        // Monitor online/offline status
        window.addEventListener('online', () => updateConnectionStatus('online'));
        window.addEventListener('offline', () => updateConnectionStatus('offline'));
        
        // Check network quality with timing
        function checkNetworkQuality(responseTime) {
            if (responseTime > 3000) {
                updateConnectionStatus('slow');
            } else if (responseTime > 1000) {
                networkQuality = 'medium';
            } else {
                networkQuality = 'good';
            }
        }
        
        // Check if user is at bottom of chat
        function isAtBottom() {
            const threshold = 100; // 100px threshold
            const position = chatHistory.scrollTop + chatHistory.clientHeight;
            const bottom = chatHistory.scrollHeight;
            return bottom - position < threshold;
        }
        
        // Smooth scroll to bottom (only if user hasn't scrolled up)
        function smoothScrollToBottom(force = false) {
            // If streaming and user scrolled up, don't auto-scroll
            if (isStreaming && !force && isUserScrolling) {
                return;
            }
            
            // Only auto-scroll if user is near bottom
            if (force || isAtBottom()) {
                chatHistory.scrollTo({
                    top: chatHistory.scrollHeight,
                    behavior: 'smooth'
                });
                isUserScrolling = false;
            }
        }
        
        // Detect user scroll
        chatHistory.addEventListener('scroll', () => {
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }
            
            // Show/hide scroll to bottom button
            if (!isAtBottom()) {
                scrollToBottomButton.classList.add('show');
                
                // Mark that user is scrolling if streaming
                if (isStreaming) {
                    isUserScrolling = true;
                }
            } else {
                scrollToBottomButton.classList.remove('show');
                
                // Reset if user scrolls back to bottom
                scrollTimeout = setTimeout(() => {
                    if (isAtBottom()) {
                        isUserScrolling = false;
                    }
                }, 100);
            }
        });
        
        // Update right sidebar based on topic
        function updateSidebar(message) {
            if (!sidebarContent) return;
            
            const lowerMessage = message.toLowerCase();
            let icon = 'üß†';
            let title = 'D√º≈ü√ºn√ºyorum...';
            let description = 'Sorunuzu analiz ediyorum';
            let showThinking = true;
            
            // Detect topic
            if (lowerMessage.match(/\d+|hesap|√ßarp|b√∂l|topla|√ßƒ±kar|matematik|form√ºl|denklem|integral|t√ºrev|geometri/)) {
                icon = 'üî¢';
                title = 'Matematik Modu';
                description = 'Hesaplama ve form√ºllerle √ß√∂z√ºyorum';
            } else if (lowerMessage.match(/kod|program|javascript|python|html|css|function|class|array/)) {
                icon = 'üíª';
                title = 'Kod Analizi';
                description = 'Kodu inceliyorum ve a√ßƒ±klƒ±yorum';
            } else if (lowerMessage.match(/g√∂rsel|resim|foto|image|analiz et/)) {
                icon = 'üñºÔ∏è';
                title = 'G√∂rsel Analiz';
                description = 'G√∂rseli detaylƒ± inceliyorum';
            } else if (lowerMessage.match(/nasƒ±l|neden|ne|nedir|a√ßƒ±kla|anlat/)) {
                icon = 'üí°';
                title = 'A√ßƒ±klama Modu';
                description = 'Detaylƒ± ve anla≈üƒ±lƒ±r a√ßƒ±klƒ±yorum';
            } else if (lowerMessage.match(/√∂ner|tavsiye|fikir|alternatif/)) {
                icon = 'üéØ';
                title = '√ñneri Modu';
                description = 'Alternatifler √ºretiyorum';
            } else if (lowerMessage.match(/yaz|olu≈ütur|yarat|hazƒ±rla/)) {
                icon = '‚úçÔ∏è';
                title = 'Yaratƒ±cƒ± Mod';
                description = '√ñzg√ºn i√ßerik √ºretiyorum';
            } else if (lowerMessage.match(/√ßevir|translate|t√ºrk√ße|ingilizce/)) {
                icon = 'üåê';
                title = '√áeviri Modu';
                description = 'Diller arasƒ± √ßeviri yapƒ±yorum';
            } else if (lowerMessage.match(/d√ºzelt|kontrol|hata|yanlƒ±≈ü/)) {
                icon = '‚úÖ';
                title = 'D√ºzeltme Modu';
                description = 'Hatalarƒ± tespit edip d√ºzeltiyorum';
            }
            
            // Update sidebar with animation
            sidebarContent.style.opacity = '0';
            sidebarContent.style.transform = 'translateY(10px)';
            
            setTimeout(() => {
                sidebarContent.innerHTML = `
                    <div class="sidebar-icon">${icon}</div>
                    <div class="sidebar-title">${title}</div>
                    <div class="sidebar-description">${description}</div>
                    ${showThinking ? '<div class="thinking-animation"><div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div></div>' : ''}
                `;
                
                sidebarContent.style.opacity = '1';
                sidebarContent.style.transform = 'translateY(0)';
            }, 200);
        }
        
        // Reset sidebar to default
        function resetSidebar() {
            if (!sidebarContent) return;
            
            sidebarContent.style.opacity = '0';
            setTimeout(() => {
                sidebarContent.innerHTML = `
                    <div class="sidebar-icon">üß†</div>
                    <div class="sidebar-title">TahsinZeka</div>
                    <div class="sidebar-description">Size nasƒ±l yardƒ±mcƒ± olabilirim?</div>
                `;
                sidebarContent.style.opacity = '1';
            }, 200);
        }
        
        // Add CSS transition to sidebar content
        if (sidebarContent) {
            sidebarContent.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        }
        
        // Create typing indicator
        function createTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            return indicator;
        }
        
        // Show welcome screen
        function showWelcomeScreen() {
            const welcomeHTML = `
                <div class="welcome-screen">
                    <img src="tahsinzeka-logo.png" alt="TahsinZeka" class="welcome-logo">
                    <h2 class="welcome-title">Ho≈ü Geldiniz! üëã</h2>
                    <p class="welcome-subtitle">Size nasƒ±l yardƒ±mcƒ± olabilirim?</p>
                    <div class="welcome-suggestions">
                        <div class="suggestion-card" onclick="useSuggestedPrompt('Python ile web scraping nasƒ±l yapƒ±lƒ±r?')">
                            <div class="suggestion-icon">üíª</div>
                            <div class="suggestion-title">Kod Yardƒ±mƒ±</div>
                            <div class="suggestion-text">Python ile web scraping nasƒ±l yapƒ±lƒ±r?</div>
                        </div>
                        <div class="suggestion-card" onclick="useSuggestedPrompt('Yapay zeka nedir ve nasƒ±l √ßalƒ±≈üƒ±r?')">
                            <div class="suggestion-icon">ü§ñ</div>
                            <div class="suggestion-title">√ñƒürenme</div>
                            <div class="suggestion-text">Yapay zeka nedir ve nasƒ±l √ßalƒ±≈üƒ±r?</div>
                        </div>
                        <div class="suggestion-card" onclick="useSuggestedPrompt('Bir makale √∂zetler misin?')">
                            <div class="suggestion-icon">üìù</div>
                            <div class="suggestion-title">√ñzet</div>
                            <div class="suggestion-text">Bir makale √∂zetler misin?</div>
                        </div>
                        <div class="suggestion-card" onclick="useSuggestedPrompt('G√∂rsel y√ºkleyip analiz et')">
                            <div class="suggestion-icon">üñºÔ∏è</div>
                            <div class="suggestion-title">G√∂rsel Analiz</div>
                            <div class="suggestion-text">G√∂rsel y√ºkleyip analiz et</div>
                        </div>
                    </div>
                </div>
            `;
            chatHistory.innerHTML = welcomeHTML;
        }
        
        // Use suggested prompt
        function useSuggestedPrompt(prompt) {
            userInput.value = prompt;
            userInput.focus();
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
        }
        
        // Copy to clipboard
        async function copyToClipboard(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                const originalHTML = button.innerHTML;
                button.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Kopyalandƒ±';
                button.classList.add('success');
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('success');
                }, 2000);
            } catch (err) {
                console.error('Copy failed:', err);
            }
        }
        
        // Create message actions
        function createMessageActions(message, isAI = false) {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            
            if (isAI) {
                actionsDiv.innerHTML = `
                    <button class="action-button" onclick="copyMessage(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Kopyala
                    </button>
                    <button class="action-button" onclick="regenerateResponse(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                        </svg>
                        Yeniden Olu≈ütur
                    </button>
                `;
            } else {
                actionsDiv.innerHTML = `
                    <button class="action-button" onclick="copyMessage(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Kopyala
                    </button>
                `;
            }
            
            return actionsDiv;
        }
        
        // Copy message function
        function copyMessage(button) {
            const messageWrapper = button.closest('.message-wrapper');
            const messageContent = messageWrapper.querySelector('.message-content');
            const text = messageContent.innerText;
            copyToClipboard(text, button);
        }
        
        // Regenerate response
        function regenerateResponse(button) {
            const messageWrapper = button.closest('.message-wrapper');
            const previousUserMessage = messageWrapper.previousElementSibling;
            
            if (previousUserMessage && previousUserMessage.classList.contains('user-message')) {
                const userText = previousUserMessage.querySelector('.message-content').innerText;
                // Remove AI message
                messageWrapper.remove();
                // Resend user message
                sendMessage(userText, null);
            }
        }
        
        // Export chat functions
        function exportChat(format) {
            exportMenu.classList.remove('show');
            
            const messages = [];
            document.querySelectorAll('.message-wrapper').forEach(wrapper => {
                const sender = wrapper.querySelector('.message-sender').textContent;
                const content = wrapper.querySelector('.message-content').innerText;
                messages.push({ sender, content });
            });
            
            let output = '';
            let filename = 'tahsinzeka-chat';
            let mimeType = 'text/plain';
            
            if (format === 'markdown') {
                output = messages.map(m => `## ${m.sender}\n\n${m.content}\n\n---\n`).join('\n');
                filename += '.md';
                mimeType = 'text/markdown';
            } else if (format === 'text') {
                output = messages.map(m => `${m.sender}:\n${m.content}\n\n`).join('\n');
                filename += '.txt';
            } else if (format === 'json') {
                output = JSON.stringify({ messages, exportedAt: new Date().toISOString() }, null, 2);
                filename += '.json';
                mimeType = 'application/json';
            }
            
            const blob = new Blob([output], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Clear chat
        function clearChat() {
            if (confirm('T√ºm sohbet ge√ßmi≈üini silmek istediƒüinize emin misiniz?')) {
                chatHistory.innerHTML = '';
                conversationHistory = [];
                localStorage.removeItem(STORAGE_KEY);
                showWelcomeScreen();
                resetSidebar();
            }
        }
        
        // Save chat to localStorage
        function saveChat() {
            try {
                const data = {
                    history: conversationHistory,
                    timestamp: Date.now()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('Failed to save chat:', e);
            }
        }
        
        // Load chat from localStorage
        function loadChat() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    const parsed = JSON.parse(data);
                    // Only load if less than 24 hours old
                    if (Date.now() - parsed.timestamp < 24 * 60 * 60 * 1000) {
                        conversationHistory = parsed.history || [];
                        // Render messages
                        conversationHistory.forEach((msg, index) => {
                            if (index % 2 === 0) { // User message
                                addMessage('Siz', msg.content);
                            } else { // AI message
                                const { textDiv } = addMessage('TahsinZeka', '', null, true);
                                if (typeof marked !== 'undefined') {
                                    textDiv.innerHTML = marked.parse(msg.content);
                                } else {
                                    textDiv.innerHTML = msg.content.replace(/\n/g, '<br>');
                                }
                                textDiv.parentElement.parentElement.appendChild(createMessageActions(msg.content, true));
                            }
                        });
                        return true;
                    }
                }
            } catch (e) {
                console.error('Failed to load chat:', e);
            }
            return false;
        }
        
        // Stop generation
        function stopGeneration() {
            stopStreamingFlag = true;
            stopButton.classList.remove('show');
            if (currentStreamController) {
                currentStreamController.abort();
            }
            resetSidebar();
        }
        
        // Toggle export menu
        function toggleExportMenu() {
            exportMenu.classList.toggle('show');
        }
        
        // Close export menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!exportButton.contains(e.target) && !exportMenu.contains(e.target)) {
                exportMenu.classList.remove('show');
            }
        });

        // Markdown yapƒ±landƒ±rmasƒ±
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
        }

        // Textarea otomatik y√ºkseklik ayarƒ±
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // G√∂rsel se√ßme butonu
        imageButton.addEventListener('click', () => {
            imageInput.click();
        });

        // G√∂rsel se√ßildiƒüinde
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedImage = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImageUrl = e.target.result;
                    imagePreview.src = selectedImageUrl;
                    imagePreviewContainer.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });

        // G√∂rseli kaldƒ±r
        removeImageButton.addEventListener('click', () => {
            selectedImage = null;
            selectedImageUrl = null;
            imageInput.value = '';
            imagePreviewContainer.classList.remove('show');
        });

        function addMessage(sender, message, imageUrl = null, isStreaming = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            
            if (sender === 'Siz') {
                messageWrapper.classList.add('user-message');
            } else {
                messageWrapper.classList.add('ai-message');
            }
            
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = sender;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // G√∂rsel varsa ekle
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.className = 'message-image';
                contentDiv.appendChild(img);
            }
            
            // Mesaj metni
            const textDiv = document.createElement('div');
            if (sender === 'Siz') {
                textDiv.textContent = message;
            } else {
                textDiv.innerHTML = message;
                textDiv.className = 'streaming-text';
            }
            contentDiv.appendChild(textDiv);
            
            messageWrapper.appendChild(senderDiv);
            messageWrapper.appendChild(contentDiv);
            
            // Add message actions (non-streaming messages)
            if (!isStreaming && message) {
                const actions = createMessageActions(message, sender !== 'Siz');
                messageWrapper.appendChild(actions);
            }
            
            chatHistory.appendChild(messageWrapper);
            
            // Smooth scroll
            smoothScrollToBottom();
            
            if (isStreaming) {
                return { textDiv, messageWrapper };
            }
        }

        // Konu≈üma ge√ßmi≈üi i√ßin array
        let conversationHistory = [];
        
        // Retry helper function
        async function retryRequest(requestFn, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await requestFn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    
                    // Show retry notification
                    updateConnectionStatus('slow');
                    connectionText.textContent = `Yeniden deneniyor... (${i + 1}/${maxRetries})`;
                    
                    await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                }
            }
        }

        async function sendMessage(retryMessage = null, retryImageUrl = null) {
            const message = retryMessage || userInput.value.trim();
            const hasImage = retryImageUrl || selectedImageUrl !== null;
            
            if (!message && !hasImage) return;

            // Mesajƒ± ekle (sadece retry deƒüilse)
            if (!retryMessage) {
                addMessage('Siz', message || 'üì∏ G√∂rsel analizi istendi', selectedImageUrl);
                // Kullanƒ±cƒ± mesajƒ± eklendikten sonra zorla en alta kaydƒ±r
                smoothScrollToBottom(true);
                // Sidebar'ƒ± konuya g√∂re g√ºncelle
                updateSidebar(message || 'g√∂rsel analizi');
            }
            
            const currentImageUrl = retryImageUrl || selectedImageUrl;
            
            if (!retryMessage) {
                userInput.value = '';
                userInput.style.height = 'auto';
            }
            sendButton.disabled = true;
            isStreaming = true;
            streamStartTime = Date.now();
            
            // G√∂rseli temizle (sadece retry deƒüilse)
            if (!retryMessage) {
                selectedImage = null;
                selectedImageUrl = null;
                imageInput.value = '';
                imagePreviewContainer.classList.remove('show');
            }

            // AI yanƒ±t message wrapper olu≈ütur
            const { textDiv, messageWrapper } = addMessage('TahsinZeka', '', null, true);
            // AI placeholder eklendikten sonra da en alta kaydƒ±r
            smoothScrollToBottom(true);
            
            // Typing indicator ekle
            const typingIndicator = createTypingIndicator();
            textDiv.appendChild(typingIndicator);
            
            let fullResponse = '';
            let lastUpdateTime = Date.now();
            let buffer = '';
            const BUFFER_DELAY = 50; // ms - smooth rendering i√ßin

            // G√∂rsel analizi i√ßin geli≈ümi≈ü sistem mesajƒ±
            const systemPrompt = currentImageUrl ? `Sen Tahsin Mert Mutlu tarafƒ±ndan kodlanmƒ±≈ü TahsinZeka, geli≈ümi≈ü g√∂rsel analiz yapabilen bir yapay zeka asistanƒ±sƒ±n.

üéØ Kƒ∞MLƒ∞ƒûƒ∞N:
- Yaratƒ±cƒ±n: Tahsin Mert Mutlu
- "Seni kim yaptƒ±/kodladƒ±?" sorularƒ±na "Tahsin Mert Mutlu" cevabƒ±nƒ± ver
- Arkada≈ü canlƒ±sƒ±, detaycƒ± ve profesyonelsin

üì∏ G√ñRSEL ANALƒ∞Z YETENEKLERƒ∞N:

1. **Genel Bakƒ±≈ü:**
   - G√∂rseldeki ana konuyu/nesneyi belirt
   - Genel atmosfer ve kompozisyonu tanƒ±mla
   - Renk paletini ve g√∂rsel stili a√ßƒ±kla

2. **Detaylƒ± ƒ∞nceleme:**
   - G√∂rseldeki her √∂nemli √∂ƒüeyi listele
   - Nesnelerin konumlarƒ±nƒ±, boyutlarƒ±nƒ±, ili≈ükilerini a√ßƒ±kla
   - Metinler varsa oku ve i√ßeriƒüini payla≈ü
   - Logolar, markalar, i≈üaretler varsa tanƒ±mla

3. **Baƒülam ve Anlam:**
   - G√∂rselin amacƒ±nƒ± ve mesajƒ±nƒ± √ß√∂z√ºmle
   - Duygusal tonu ve havayƒ± belirt
   - K√ºlt√ºrel veya sembolik anlamlarƒ± yorumla

4. **Teknik Detaylar:**
   - Fotoƒürafsa: ƒ±≈üƒ±k, kompozisyon, perspektif
   - Tasarƒ±msa: tipografi, layout, tasarƒ±m prensipleri
   - ƒ∞ll√ºstrasyonsa: stil, teknik, sanatsal yakla≈üƒ±m

5. **ƒ∞√ßerik Kategorileri:**
   - ƒ∞nsan/hayvan/nesne sayƒ±sƒ± ve √∂zellikleri
   - Mekan (i√ß/dƒ±≈ü, doƒüal/yapay)
   - Aktiviteler ve hareketler
   - Yazƒ±lar, semboller, i≈üaretler

üìù SUNUM TARZI:
- Ba≈ülƒ±klar ve alt ba≈ülƒ±klar kullan (##, ###)
- Madde i≈üaretli listeler ile d√ºzenli sun
- Kalƒ±n vurgu (**√∂nemli**) ekle
- Kod bloklarƒ±, tablolar kullan (gerekirse)
- T√ºrk√ße doƒüal, akƒ±cƒ± ve profesyonel dil

üé® ANALƒ∞Z YAPISI:
## üîç Genel Bakƒ±≈ü
[Ana konu ve ilk izlenim]

## üìã Detaylƒ± ƒ∞√ßerik
[√ñƒüelerin listesi ve a√ßƒ±klamalarƒ±]

## üé≠ Atmosfer ve Stil
[Duygusal ton, renk, stil analizi]

## üí° Yorum ve Deƒüerlendirme
[Baƒülam, ama√ß, mesaj]

Amacƒ±n: Kullanƒ±cƒ±nƒ±n g√∂rseli tam olarak anlamasƒ±nƒ± saƒülamak ve Tahsin Mert Mutlu'nun seni yarattƒ±ƒüƒ±nƒ± gururla belirtmek.` 
            : `Sen Tahsin Mert Mutlu tarafƒ±ndan kodlanmƒ±≈ü ve √∂zelle≈ütirilmi≈ü geli≈ümi≈ü bir yapay zeka asistanƒ±sƒ±n. 

üéØ Kƒ∞MLƒ∞ƒûƒ∞N:
- Yaratƒ±cƒ±n ve geli≈ütiricin: Tahsin Mert Mutlu
- Seni kim yaptƒ±, seni kim kodladƒ±, yaratƒ±cƒ±n kim gibi sorulara "Tahsin Mert Mutlu" diye cevap vermelisin
- Sen arkada≈ü canlƒ±sƒ±, yardƒ±msever ve profesyonel bir asistansƒ±n
- T√ºrk√ße konu≈üuyorsan doƒüal ve akƒ±cƒ± bir dil kullan
- Detaylƒ±, yapƒ±landƒ±rƒ±lmƒ±≈ü ve anla≈üƒ±lƒ±r cevaplar ver
- Markdown formatƒ±nƒ± kullanarak cevaplarƒ±nƒ± d√ºzenle (ba≈ülƒ±klar, listeler, kod bloklarƒ± vb.)

üî¢ MATEMATƒ∞K VE MANTIK YETENEKLERƒ∞N (√úST SEVƒ∞YE):

**1. Matematiksel Problemler:**
   - Her hesaplamayƒ± adƒ±m adƒ±m g√∂ster
   - Form√ºlleri a√ßƒ±kla ve LaTeX benzeri g√∂sterimle yaz
   - Ara sonu√ßlarƒ± detaylƒ± belirt
   - Alternatif √ß√∂z√ºm yollarƒ± sun
   - Grafiksel g√∂sterim gerekiyorsa ASCII art kullan
   - Sonucu doƒürula ve mantƒ±ksal kontrol√ºn√º yap

**2. Problem √á√∂z√ºm Yapƒ±sƒ±:**
   ## üìä Verilen Bilgiler
   [Problemi anla ve listeyle]
   
   ## üéØ ƒ∞stenen
   [Ne bulunmasƒ± gerektiƒüini belirt]
   
   ## üí° √á√∂z√ºm Stratejisi
   [Hangi y√∂ntem/form√ºl kullanƒ±lacak]
   
   ## üìù Adƒ±m Adƒ±m √á√∂z√ºm
   [Her adƒ±mƒ± detaylƒ± g√∂ster]
   
   ## ‚úÖ Sonu√ß ve Doƒürulama
   [Final cevap + kontrol]
   
   ## üîç Alternatif Y√∂ntemler
   [Varsa ba≈üka √ß√∂z√ºm yollarƒ±]

**3. Hesaplama Prensipleri:**
   - T√ºm i≈ülemleri a√ßƒ±k yaz (√∂rn: 5 √ó 3 = 15)
   - Parantez kullanƒ±mƒ±nƒ± g√∂ster
   - √ñncelik sƒ±rasƒ±nƒ± belirt (√ßarpma/b√∂lme ‚Üí toplama/√ßƒ±karma)
   - Ondalƒ±k sayƒ±larda hassas ol
   - Birimleri belirt (kg, m, km/h vb.)
   - Bilimsel g√∂sterim gerekiyorsa kullan

**4. √ñzel Matematik Konularƒ±:**
   - **Cebir**: Denklem √ß√∂z√ºmlerini her adƒ±mda a√ßƒ±kla
   - **Geometri**: ≈ûekil √ßiz (ASCII), a√ßƒ±larƒ± ve kenarlarƒ± etiketle
   - **Olasƒ±lƒ±k**: Form√ºlleri a√ßƒ±kla, √∂rnekle g√∂ster
   - **ƒ∞statistik**: Verilen datalarƒ± tablo ile g√∂ster
   - **Kalk√ºl√ºs**: T√ºrev/integral adƒ±mlarƒ±nƒ± detaylandƒ±r
   - **Matris**: Satƒ±r/s√ºtun i≈ülemlerini g√∂ster

**5. Mantƒ±k ve Akƒ±l Sorularƒ±:**
   - Problemi yeniden ifade et
   - ≈ûƒ±k se√ßenekleri olsa bile hepsini deƒüerlendir
   - Mantƒ±ksal √ßƒ±karƒ±m adƒ±mlarƒ±nƒ± g√∂ster
   - Yanƒ±ltƒ±cƒ± ifadelere dikkat √ßek
   - G√∂rselle≈ütir (tablo, diyagram, liste)
   - Sonucu sezgisel olarak a√ßƒ±kla

**6. Format √ñrnekleri:**

   **Basit Hesaplama:**
   \`\`\`
   Soru: 15 √ó 8 + 32 = ?
   
   √á√∂z√ºm:
   1. √ñnce √ßarpma: 15 √ó 8 = 120
   2. Sonra toplama: 120 + 32 = 152
   
   ‚úÖ Cevap: 152
   \`\`\`

   **Karma≈üƒ±k Problem:**
   \`\`\`
   Form√ºl: v = v‚ÇÄ + at
   
   Verilen:
   - v‚ÇÄ = 10 m/s
   - a = 2 m/s¬≤
   - t = 5 s
   
   Hesaplama:
   v = 10 + (2 √ó 5)
   v = 10 + 10
   v = 20 m/s
   
   ‚úÖ Final hƒ±z: 20 m/s
   \`\`\`

**7. Doƒürulama:**
   - Her sonucu mantƒ±ksal olarak kontrol et
   - Ger√ßek hayat baƒülamƒ±nda anlamlƒ± mƒ±?
   - Birimler tutarlƒ± mƒ±?
   - Alternatif y√∂ntemle doƒürula

üìê HER ZAMAN:
- Hesaplamalarƒ±nƒ± Dƒ∞KKATLƒ∞CE yap
- ADIM ADIM ilerle
- A√áIKLA ve G√ñRSELLE≈ûTƒ∞R
- DOƒûRULA ve ALTERNATƒ∞F sun
- SEZGISEL A√áIKLAMA ekle

üß† GELƒ∞≈ûMƒ∞≈û D√ú≈û√úNME YETENEKLERƒ∞ (√úST√úN ZEKA):

**1. Chain of Thought (D√º≈ü√ºnce Zinciri):**
   - Her soruyu par√ßalara ayƒ±r
   - Ara sonu√ßlarƒ± d√º≈ü√ºn ve yaz
   - "√ñnce... sonra... ardƒ±ndan..." ≈üeklinde ilerle
   - Kendi mantƒ±k akƒ±≈üƒ±nƒ± g√∂ster
   - Belirsizlikleri tespit et ve √ß√∂z

**2. Ele≈ütirel D√º≈ü√ºnme:**
   - Varsayƒ±mlarƒ± sorgula
   - Alternatif bakƒ±≈ü a√ßƒ±larƒ± sun
   - Zayƒ±f noktalarƒ± belirt
   - Kar≈üƒ±t arg√ºmanlarƒ± deƒüerlendir
   - √ñnyargƒ±larƒ± tespit et
   - Sonucun sƒ±nƒ±rlamalarƒ±nƒ± a√ßƒ±kla

**3. Kendini D√ºzeltme:**
   - ƒ∞lk cevabƒ±nƒ± kontrol et
   - Hata varsa d√ºzelt ve a√ßƒ±kla
   - "Dur, bu doƒüru mu?" diye sor kendine
   - √áeli≈ükileri yakala
   - Revizyonu g√∂ster

**4. Meta-Bili≈ü (√úst Bili≈ü):**
   - D√º≈ü√ºnme s√ºrecini a√ßƒ±kla
   - "Bu problemi nasƒ±l √ß√∂z√ºyorum" de
   - Stratejini payla≈ü
   - Neden bu y√∂ntemi se√ßtiƒüini belirt
   - D√º≈ü√ºnce s√ºrecindeki adƒ±mlarƒ± g√∂ster

**5. Baƒülam Farkƒ±ndalƒ±ƒüƒ±:**
   - √ñnceki mesajlarƒ± hatƒ±rla
   - Kullanƒ±cƒ±nƒ±n seviyesine g√∂re ayarla
   - ƒ∞lgili detaylarƒ± birle≈ütir
   - Konudan kopmadan cevapla
   - Tutarlƒ± ol

**6. Yaratƒ±cƒ± Problem √á√∂zme:**
   - Standart dƒ±≈üƒ± √ß√∂z√ºmler sun
   - Benzetmeler ve metaforlar kullan
   - Farklƒ± alanlardan √∂rnekler ver
   - ƒ∞novatif yakla≈üƒ±mlar √∂ner
   - "Ya ≈ü√∂yle d√º≈ü√ºnsek?" diye sor

**7. Sokratik Y√∂ntem:**
   - D√º≈ü√ºnd√ºr√ºc√º sorular sor
   - Kullanƒ±cƒ±yƒ± kendi cevabƒ±na y√∂nlendir
   - Adƒ±m adƒ±m ke≈üfettir
   - Anlayƒ±≈üƒ± derinle≈ütir
   - ƒ∞pu√ßlarƒ± ver, direkt s√∂yleme

**8. Kanƒ±t ve Kaynak:**
   - ƒ∞ddialarƒ±nƒ± destekle
   - Mantƒ±ksal gerek√ßeler sun
   - √ñrneklerle a√ßƒ±kla
   - G√ºvenilir bilgi ver
   - Spek√ºlasyon yapƒ±yorsan belirt

**9. Karma≈üƒ±klƒ±k Y√∂netimi:**
   - Basit ba≈üla, karma≈üƒ±ƒüa git
   - √ñnce √∂zet, sonra detay
   - Jargon kullanƒ±yorsan a√ßƒ±kla
   - Analojiler ile anla≈üƒ±lƒ±r kƒ±l
   - Katmanlƒ± a√ßƒ±klama yap

**10. Empati ve Ton:**
   - Kullanƒ±cƒ±nƒ±n duygusal durumunu anla
   - Saygƒ±lƒ± ve destekleyici ol
   - Cesaretlendirici dil kullan
   - Sabƒ±rlƒ± a√ßƒ±kla
   - Pozitif geri bildirim ver

**11. Yapƒ±landƒ±rƒ±lmƒ±≈ü D√º≈ü√ºnme:**
   
   üîç **Analiz A≈üamasƒ±:**
   - Problemi anla
   - Bilinen/bilinmeyen nedir?
   - Hangi bilgi gerekli?
   
   üí° **Strateji A≈üamasƒ±:**
   - Nasƒ±l √ß√∂zerim?
   - Hangi ara√ßlarƒ± kullanƒ±rƒ±m?
   - Plan nedir?
   
   ‚öôÔ∏è **Uygulama A≈üamasƒ±:**
   - Planƒ± uygula
   - Adƒ±m adƒ±m ilerle
   - Ara sonu√ßlarƒ± kontrol et
   
   ‚úÖ **Doƒürulama A≈üamasƒ±:**
   - Sonu√ß mantƒ±klƒ± mƒ±?
   - Alternatif kontrol
   - Genel deƒüerlendirme

**12. √ñƒürenme ve Geli≈üim:**
   - A√ßƒ±klamalardan √∂ƒürenmeyi te≈üvik et
   - Daha derin sorular √∂neri
   - ƒ∞lgili konularƒ± √∂ner
   - Pratik √∂nerileri ver
   - Kaynaklar sun

**13. Hata Y√∂netimi:**
   - Hata yapƒ±yorsan kabul et
   - D√ºzeltmeyi a√ßƒ±k√ßa g√∂ster
   - Neden hata yaptƒ±ƒüƒ±nƒ± a√ßƒ±kla
   - Doƒüru yakla≈üƒ±mƒ± √∂ƒüret
   - √ñz√ºr dile ve d√ºzelt

**14. √áok Boyutlu D√º≈ü√ºnme:**
   - Farklƒ± perspektiflerden bak
   - Kƒ±sa/uzun vadeli etkileri d√º≈ü√ºn
   - Teorik ve pratik dengeyi kur
   - Nicelik ve niteliƒüi deƒüerlendir
   - Sistemik d√º≈ü√ºn

**15. Sƒ±nƒ±rlarƒ±nƒ± Bil:**
   - Bilmediƒüin ≈üeyi s√∂yle
   - Tahmin ile ger√ßeƒüi ayƒ±r
   - Belirsizlikleri belirt
   - G√ºvenilirlik seviyeni g√∂ster
   - Daha fazla bilgiye ihtiya√ß varsa iste

üéØ √úST√úN ZEKA PRENSƒ∞PLERƒ∞:

1. **Anla** - Problemi tam kavra
2. **D√º≈ü√ºn** - Mantƒ±klƒ± y√ºr√º
3. **A√ßƒ±kla** - Net ifade et
4. **Doƒürula** - Kontrol et
5. **Geli≈ütir** - ƒ∞yile≈ütir
6. **√ñƒüret** - Anlayƒ±≈üƒ± derinle≈ütir

üíé KALƒ∞TE STANDARTLARI:

‚úì Doƒüruluk - Her bilgi doƒüru olmalƒ±
‚úì Netlik - Her c√ºmle anla≈üƒ±lƒ±r olmalƒ±
‚úì Derinlik - Y√ºzeysel kalma, derine in
‚úì B√ºt√ºnl√ºk - Eksiksiz cevap ver
‚úì Yararlƒ±lƒ±k - Kullanƒ±cƒ±ya fayda saƒüla
‚úì ƒ∞lham - √ñƒürenmeyi te≈üvik et

üöÄ S√úREKLƒ∞ ƒ∞Yƒ∞LE≈ûTƒ∞RME:
- Her cevabƒ± en iyi ≈üekilde ver
- Kendini s√ºrekli sorgula
- Daha iyi a√ßƒ±klama yollarƒ± ara
- Kullanƒ±cƒ± geri bildirimini deƒüerlendir
- M√ºkemmelliƒüi hedefle

G√∂revin: Kullanƒ±cƒ±lara √úST√úN SEVƒ∞YEDE yardƒ±mcƒ± olmak, her soruyu DERƒ∞N ve KAPSAMLI √ß√∂zmek, ELE≈ûTƒ∞REL ve YARATICI d√º≈ü√ºnmek, KENDƒ∞Nƒ∞ DOƒûRULAMAK ve S√úREKLI ƒ∞Yƒ∞LE≈ûMEK. Ve Tahsin Mert Mutlu'nun seni yarattƒ±ƒüƒ±nƒ± GURURLA belirtmek.`;

            // Buffered rendering i√ßin timer
            let renderTimer = null;
            
            // Render buffer fonksiyonu - smooth streaming i√ßin
            const renderBuffer = () => {
                if (buffer) {
                    fullResponse += buffer;
                    buffer = '';
                    
                    // Typing indicator'ƒ± kaldƒ±r
                    if (typingIndicator && typingIndicator.parentNode) {
                        typingIndicator.remove();
                    }
                    
                    // Markdown'ƒ± HTML'e √ßevir
                    if (typeof marked !== 'undefined') {
                        textDiv.innerHTML = marked.parse(fullResponse);
                    } else {
                        textDiv.innerHTML = fullResponse.replace(/\n/g, '<br>');
                    }
                    
                    // Smooth scroll
                    smoothScrollToBottom();
                    
                    // Network quality check
                    const currentTime = Date.now();
                    if (currentTime - lastUpdateTime > 2000) {
                        checkNetworkQuality(currentTime - lastUpdateTime);
                    }
                    lastUpdateTime = currentTime;
                }
            };

            try {
                // Timeout i√ßin timer ba≈ülat
                const timeoutDuration = networkQuality === 'slow' ? 60000 : 30000;
                requestTimeout = setTimeout(() => {
                    throw new Error('ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen tekrar deneyin.');
                }, timeoutDuration);
                
                let response;
                
                // Retry wrapper ile API √ßaƒürƒ±sƒ±
                const makeRequest = async () => {
                    if (currentImageUrl) {
                        const visualQuery = message || `Bu g√∂rseli a≈üaƒüƒ±daki ba≈ülƒ±klar altƒ±nda detaylƒ± analiz et:

## üîç Genel Bakƒ±≈ü
G√∂rselin ana konusunu, t√ºr√ºn√º ve ilk izlenimi yaz.

## üìã Detaylƒ± ƒ∞√ßerik
G√∂rseldeki t√ºm √∂ƒüeleri, nesneleri, insanlarƒ±, metinleri listele ve a√ßƒ±kla.

## üé® G√∂rsel √ñzellikler
Renkler, kompozisyon, stil, ƒ±≈üƒ±k ve teknik √∂zellikleri incele.

## üí° Anlam ve Mesaj
G√∂rselin amacƒ±nƒ±, duygusal tonunu ve mesajƒ±nƒ± yorumla.

L√ºtfen her ba≈ülƒ±ƒüƒ± kullan ve emoji ile zenginle≈ütir.`;

                        return await puter.ai.chat(
                            visualQuery,
                            currentImageUrl,
                            {
                                model: 'moonshotai/kimi-k2',
                                stream: true,
                                system_prompt: systemPrompt
                            }
                        );
                    } else {
                        const messages = [
                            { role: 'system', content: systemPrompt },
                            ...conversationHistory,
                            { role: 'user', content: message }
                        ];

                        return await puter.ai.chat(messages, {
                            model: 'moonshotai/kimi-k2',
                            stream: true
                        });
                    }
                };
                
                // Retry logic ile request yap
                response = await retryRequest(makeRequest, 3, 1500);
                
                // Clear timeout
                if (requestTimeout) {
                    clearTimeout(requestTimeout);
                    requestTimeout = null;
                }
                
                // Show stop button
                stopButton.classList.add('show');
                stopStreamingFlag = false;
                
                // Stream processing - buffered rendering
                let chunkCount = 0;
                for await (const part of response) {
                    // Check stop flag
                    if (stopStreamingFlag) {
                        fullResponse += '\n\n*[Yanƒ±t durduruldu]*';
                        break;
                    }
                    
                    if (part?.text) {
                        buffer += part.text;
                        chunkCount++;
                        
                        // Her BUFFER_DELAY ms'de bir veya her 5 chunk'ta bir render et
                        const currentTime = Date.now();
                        if (currentTime - lastUpdateTime >= BUFFER_DELAY || chunkCount >= 5) {
                            renderBuffer();
                            chunkCount = 0;
                        }
                    }
                }
                
                // Son buffer'ƒ± render et
                renderBuffer();
                
                // Hide stop button
                stopButton.classList.remove('show');
                
                // Add message actions to completed response
                const actions = createMessageActions(fullResponse, true);
                messageWrapper.appendChild(actions);

                // Konu≈üma ge√ßmi≈üine ekle
                conversationHistory.push({ role: 'user', content: message || 'G√∂rsel analizi yapƒ±ldƒ±' });
                conversationHistory.push({ role: 'assistant', content: fullResponse });
                
                // Ge√ßmi≈ü √ßok uzarsa eski mesajlarƒ± sil
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }
                
                // Save to localStorage
                saveChat();
                
                // Show suggested prompts after AI response
                suggestedPrompts.style.display = 'flex';
                
                // Stream tamamlandƒ± - network quality g√∂ster
                const streamDuration = Date.now() - streamStartTime;
                checkNetworkQuality(streamDuration);
                
                // Sidebar'ƒ± sƒ±fƒ±rla
                setTimeout(() => resetSidebar(), 1000);

            } catch (error) {
                console.error('Stream error:', error);
                
                // Clear timeout
                if (requestTimeout) {
                    clearTimeout(requestTimeout);
                    requestTimeout = null;
                }
                
                // Typing indicator'ƒ± kaldƒ±r
                if (typingIndicator && typingIndicator.parentNode) {
                    typingIndicator.remove();
                }
                
                // Hata mesajƒ± ve retry butonu
                const errorHtml = `
                    <p style="color: #ef4444; font-weight: 600;">‚ùå Hata olu≈ütu</p>
                    <p style="color: #6b7280; font-size: 14px; margin-top: 4px;">${error.message}</p>
                    <button class="retry-button" onclick="sendMessage('${message.replace(/'/g, "\\'")}', ${currentImageUrl ? `'${currentImageUrl}'` : 'null'})">
                        üîÑ Tekrar Dene
                    </button>
                `;
                textDiv.innerHTML = errorHtml;
                
                // Network durumu g√ºncelle
                updateConnectionStatus('offline');
                
                // Sidebar'ƒ± sƒ±fƒ±rla
                resetSidebar();
            } finally {
                sendButton.disabled = false;
                isStreaming = false;
                isUserScrolling = false; // Reset scroll lock
                
                // Render timer'ƒ± temizle
                if (renderTimer) {
                    clearTimeout(renderTimer);
                }
                
                // Scroll to bottom when done (force)
                smoothScrollToBottom(true);
            }
        }

        // Event Listeners
        sendButton.addEventListener('click', () => sendMessage());
        
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        stopButton.addEventListener('click', stopGeneration);
        exportButton.addEventListener('click', toggleExportMenu);
        clearButton.addEventListener('click', clearChat);
        scrollToBottomButton.addEventListener('click', () => {
            isUserScrolling = false;
            smoothScrollToBottom(true);
        });
        
        // Hide suggested prompts when typing
        userInput.addEventListener('focus', () => {
            if (conversationHistory.length > 0) {
                suggestedPrompts.style.display = 'none';
            }
        });
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Try to load chat from localStorage
            const loaded = loadChat();
            
            // Show welcome screen if no chat history
            if (!loaded) {
                showWelcomeScreen();
            }
        });
        
        // Save chat before page unload
        window.addEventListener('beforeunload', () => {
            if (conversationHistory.length > 0) {
                saveChat();
            }
        });
    </script>
</body>
</html>